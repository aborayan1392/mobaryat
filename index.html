<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- START: تعديلات PWA -->
    <meta name="theme-color" content="#1f2937">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png"> <!-- أيقونة للآيفون -->
    <!-- END: تعديلات PWA -->
    <title>جدول المباريات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f9fafb;
        }
        th, td {
            text-align: center;
            padding: 8px 4px;
            vertical-align: middle;
        }
        th {
            background-color: #1f2937;
            color: white;
            font-size: 0.8rem;
        }
        /* تحسين شكل الحقول الافتراضية */
        input[type="text"], input[type="number"], input[type="date"], input[type="time"] {
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            width: 100%;
            box-sizing: border-box;
            font-size: 0.9rem;
            text-align: center;
        }
        input:focus {
            outline: none;
            border-color: #3b82f6; /* لون أزرق عند التركيز */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        /* --- تنسيق بطاقة المباراة القابلة للتعديل --- */
        .match-card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .match-card.collapsed {
            padding: 0.75rem;
        }
        .match-card-header {
            position: relative;
        }
        .collapse-btn {
            position: absolute;
            top: -5px;
            left: -5px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }
        .collapse-btn:hover {
            background: #e5e7eb;
            transform: scale(1.1);
        }
        .collapse-btn i {
            font-size: 0.8rem;
            color: #6b7280;
            transition: transform 0.3s ease;
        }
        .match-card.collapsed .collapse-btn i {
            transform: rotate(180deg);
        }
        .match-card-collapsible {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 500px;
            opacity: 1;
        }
        .match-card.collapsed .match-card-collapsible {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }
        /* قسم الفرق والنتيجة */
        .match-card-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr; /* فريق - vs/نتيجة - فريق */
            align-items: center;
            gap: 0.5rem; /* مسافة بين العناصر */
            margin-bottom: 1rem;
            text-align: center;
        }
         .match-card-header .team-block {
             display: flex;
             flex-direction: column;
             align-items: center;
         }
        .match-card-header input[type="text"] { /* اسم الفريق */
            font-weight: bold;
            font-size: 1rem;
            border: none; /* إزالة الحد */
            background: #f9fafb; /* خلفية خفيفة للتمييز */
            padding: 4px;
            margin-bottom: 0.25rem;
        }
        .match-card-header input[type="number"] { /* النتيجة */
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            background: #f9fafb;
            padding: 4px;
            width: 60px; /* تحديد عرض حقل النتيجة */
            margin: 0 auto; /* توسيط */
        }
        .match-card-header .vs {
            font-size: 0.9rem;
            color: #6b7280; /* رمادي */
            font-weight: bold;
            align-self: center; /* محاذاة رأسية في المنتصف */
             margin-top: 20px; /* لضبط المحاذاة مع حقول الادخال */
        }

        /* قسم تفاصيل المباراة المحسوبة */
        .match-card-details {
            margin-bottom: 1rem;
        }
        .match-card-details div, .match-card-datetime div {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            font-size: 0.9rem;
            border-bottom: 1px dashed #eee;
        }
         .match-card-details div:last-child, .match-card-datetime div:last-child {
            border-bottom: none;
         }
        .match-card .label {
            font-weight: 600;
            color: #4b5563;
        }
        .match-card .value {
            color: #1f2937;
            min-width: 30px; /* ضمان وجود مساحة للعرض */
             text-align: left;
        }

        /* قسم التاريخ والوقت القابل للتعديل */
        .match-card-datetime input[type="date"],
        .match-card-datetime input[type="time"] {
            border: none;
            background: #f9fafb;
            padding: 4px;
            text-align: left; /* محاذاة لليسار لتناسب شكل الحقل */
            flex-grow: 1; /* السماح للحقل بأخذ المساحة المتاحة */
            margin-right: 10px; /* مسافة بين التسمية والحقل */
             width: auto; /* إعادة تعيين العرض الافتراضي */
        }
         /* إزالة الأسهم من حقول الأرقام */
         input[type=number]::-webkit-inner-spin-button,
         input[type=number]::-webkit-outer-spin-button {
             -webkit-appearance: none;
             margin: 0;
         }
         input[type=number] {
             -moz-appearance: textfield; /* Firefox */
         }

        .match-card-actions {
            text-align: left;
            margin-top: 0.75rem;
        }
        .action-btn {
            transition: all 0.3s ease;
        }
        .action-btn:hover {
            transform: scale(1.1);
        }

        /* --- تنسيق نافذة الإحصائيات --- */
        .stats-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        .stats-modal.hidden {
            display: none;
        }
        .stats-content {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        .stats-card.green {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .stats-card.red {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .stats-card.yellow {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #2d3748;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .stats-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .team-stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .team-stats-table th,
        .team-stats-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }
        .team-stats-table th {
            background-color: #f8fafc;
            color: #374151;
            font-weight: 600;
        }
        .team-stats-table tr:hover {
            background-color: #f9fafb;
        }

        /* إخفاء عناصر التحكم في الطباعة */
        @media print {
            .print-hidden { display: none !important; }
            .responsive-table { display: table !important; width: 100%; border-collapse: collapse; overflow-x: hidden; }
            .responsive-cards { display: none !important; }
            th, td { border: 1px solid #000; padding: 6px; font-size: 10pt; }
            /* عند الطباعة، أظهر القيم فقط بدون حقول إدخال */
            input[type="text"], input[type="number"], input[type="date"], input[type="time"] {
                 border: none; background-color: transparent; padding: 0; margin: 0; width: auto; font-size: inherit; text-align: center; display: inline; /* لعرض القيمة فقط */
                 -webkit-appearance: none; /* لإخفاء واجهة المستخدم الخاصة بالمتصفح */
                 -moz-appearance: textfield;
            }
            /* إخفاء حقول الادخال المكررة في البطاقة عند الطباعة */
            .match-card input { display: none; }
            /* إظهار القيم المحسوبة كنص عادي */
            .match-card .value { display: inline; }
             
             /* FIX: تعديل للطباعة - إظهار قيم نصية بديلة للبطاقات */
            .match-card-header .team-block::after {
                content: attr(data-team-name) " " attr(data-team-score);
                font-size: 1.1rem;
                font-weight: bold;
            }
            .match-card-header .vs { display: inline; }
            .match-card-header .team-block input { display: none !important; }
            /* --- نهاية التعديل --- */

            body { background-color: white; padding: 0; margin: 0; }
            .container { margin: 0; max-width: 100%; }
            h1, h2 { text-align: center; margin-bottom: 10px; }
            .table-wrapper { box-shadow: none; border: 1px solid #ccc; margin-bottom: 15px; page-break-inside: avoid; }
        }

        /* الوضع المظلم */
        @media (prefers-color-scheme: dark) {
            .dark body {
                background-color: #111827;
                color: #f9fafb;
            }
            .dark .bg-white {
                background-color: #1f2937 !important;
            }
            .dark .text-gray-700 {
                color: #d1d5db !important;
            }
            .dark .text-gray-500 {
                color: #9ca3af !important;
            }
            .dark .border-gray-200 {
                border-color: #374151 !important;
            }
            .dark .border-gray-300 {
                border-color: #4b5563 !important;
            }
            .dark input[type="text"], 
            .dark input[type="number"], 
            .dark input[type="date"], 
            .dark input[type="time"] {
                background-color: #374151;
                border-color: #4b5563;
                color: #f9fafb;
            }
            .dark .stats-content {
                background-color: #1f2937;
                color: #f9fafb;
            }
            .dark .team-stats-table th {
                background-color: #374151;
                color: #f9fafb;
            }
            .dark .collapse-btn {
                background: #374151;
                border-color: #4b5563;
            }
            .dark .collapse-btn:hover {
                background: #4b5563;
            }
            .dark #dataMenu {
                background-color: #1f2937;
                border-color: #374151;
                color: #f9fafb;
            }
            .dark #dataMenu button:hover {
                background-color: #374151;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div class="container mx-auto max-w-6xl">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div class="flex gap-2 w-full md:w-auto order-last md:order-first">
                <button onclick="printPage()" class="print-hidden bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700 flex-1 md:flex-none">
                    <i class="fas fa-print"></i> طباعة
                </button>
                <button onclick="showStatistics()" class="print-hidden bg-green-500 text-white px-4 py-2 rounded hover:bg-green-700 flex-1 md:flex-none">
                    <i class="fas fa-chart-bar"></i> الإحصائيات
                </button>
                <div class="relative flex-1 md:flex-none">
                    <button onclick="toggleDataMenu()" id="dataMenuBtn" class="print-hidden bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-700 w-full">
                        <i class="fas fa-cog"></i> إدارة البيانات
                    </button>
                    <div id="dataMenu" class="absolute top-full left-0 mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg min-w-48 z-50 hidden">
                        <button onclick="exportData()" class="w-full text-right px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2 border-b border-gray-200 dark:border-gray-600">
                            <i class="fas fa-download text-blue-500"></i>
                            <span>تصدير البيانات</span>
                        </button>
                        <button onclick="importData()" class="w-full text-right px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2 border-b border-gray-200 dark:border-gray-600">
                            <i class="fas fa-upload text-green-500"></i>
                            <span>استيراد البيانات</span>
                        </button>
                        <button onclick="resetApp()" class="w-full text-right px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                            <i class="fas fa-refresh text-red-500"></i>
                            <span>تهيئة التطبيق</span>
                        </button>
                    </div>
                </div>
            </div>
            <h1 class="text-3xl font-bold text-center order-first md:order-none">جدول المباريات</h1>
            <button onclick="addNewTable()" class="print-hidden bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-700 w-full md:w-auto order-last md:order-none">
                <i class="fas fa-table"></i> إضافة جدول جديد
            </button>
        </div>

        <div id="tables-container">
            <!-- الجداول سيتم تحميلها هنا -->
        </div>
    </div>

    <!-- نافذة الإحصائيات -->
    <div id="statsModal" class="stats-modal hidden">
        <div class="stats-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">إحصائيات المباريات</h2>
                <button onclick="closeStatistics()" class="text-red-500 hover:text-red-700 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="stats-grid">
                <div class="stats-card">
                    <div class="stats-number" id="totalMatches">0</div>
                    <div class="stats-label">إجمالي المباريات</div>
                </div>
                <div class="stats-card green">
                    <div class="stats-number" id="totalGoals">0</div>
                    <div class="stats-label">إجمالي الأهداف</div>
                </div>
                <div class="stats-card red">
                    <div class="stats-number" id="totalTeams">0</div>
                    <div class="stats-label">إجمالي الفرق</div>
                </div>
                <div class="stats-card yellow">
                    <div class="stats-number" id="avgGoalsPerMatch">0</div>
                    <div class="stats-label">متوسط الأهداف للمباراة</div>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-bold mb-4">إحصائيات الفرق</h3>
                <div class="overflow-x-auto">
                    <table class="team-stats-table">
                        <thead>
                            <tr>
                                <th>الفريق</th>
                                <th>المباريات</th>
                                <th>الفوز</th>
                                <th>التعادل</th>
                                <th>الخسارة</th>
                                <th>الأهداف المسجلة</th>
                                <th>الأهداف المستقبلة</th>
                                <th>فرق الأهداف</th>
                                <th>النقاط</th>
                                <th>نسبة الفوز</th>
                            </tr>
                        </thead>
                        <tbody id="teamStatsBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="mt-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-bold mb-3 text-green-600">الفرق الأكثر تسجيلاً</h3>
                        <div id="topScorers" class="space-y-2"></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-3 text-blue-600">الفرق الأقل استقبالاً للأهداف</h3>
                        <div id="bestDefenders" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // START: تعديل PWA - تسجيل الـ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
        // END: تعديل PWA

        // إعداد الوضع المظلم
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAllTables();
        });

        function loadAllTables() {
            const savedTablesJson = localStorage.getItem('savedTables');
            let savedTables = [];
            
            if (savedTablesJson) {
                try {
                    savedTables = JSON.parse(savedTablesJson);
                    if (!Array.isArray(savedTables)) {
                        savedTables = [];
                        localStorage.setItem('savedTables', JSON.stringify(savedTables));
                    }
                } catch (e) {
                    console.error("Error parsing savedTables from localStorage:", e);
                    savedTables = [];
                    localStorage.setItem('savedTables', JSON.stringify(savedTables));
                }
            }

            const tablesContainer = document.getElementById('tables-container');
            tablesContainer.innerHTML = ''; 

            let defaultTableDataExists = !!localStorage.getItem('matches-table');
            let defaultTableInList = savedTables.some(item => item === 'matches-table' || (typeof item === 'object' && item.id === 'matches-table'));

             if (defaultTableDataExists && !defaultTableInList) {
                 savedTables.unshift('matches-table');
             }
             else if (!defaultTableDataExists && defaultTableInList) {
                 savedTables = savedTables.filter(item => (typeof item === 'string' ? item : item.id) !== 'matches-table');
                 localStorage.setItem('savedTables', JSON.stringify(savedTables));
             }

            let tablesCreated = false;

            savedTables.forEach(tableId => {
                const id = typeof tableId === 'object' ? tableId.id : tableId;
                if (localStorage.getItem(id) || id === 'matches-table') {
                    const tableTitle = localStorage.getItem(`${id}-title`) || (id === 'matches-table' ? 'جدول المباريات الأساسي' : `جدول ${id}`);
                    if (!document.getElementById(`${id}-container`)) {
                        createTableStructure(id, tableTitle);
                        loadMatches(id);
                        tablesCreated = true;
                    }
                }
            });

            if (!tablesCreated && tablesContainer.children.length === 0) {
                createTableStructure('matches-table', 'جدول المباريات الأساسي');
                loadMatches('matches-table');
            }
            
            loadCardStates();
        }

        function createTableStructure(tableId, tableTitle) {
            if (document.getElementById(`${tableId}-container`)) return;

            const tablesContainer = document.getElementById('tables-container');
            const tableWrapper = document.createElement('div');
            tableWrapper.className = 'bg-white shadow-lg rounded-lg mb-8 table-wrapper border border-gray-200';
            tableWrapper.id = `${tableId}-container`;
            tableWrapper.dataset.tableId = tableId;

            const initialData = JSON.parse(localStorage.getItem(tableId)) || [];
            const isEmpty = initialData.length === 0;

             tableWrapper.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-center p-4 border-b border-gray-200 gap-2">
                    <h2 class="text-xl font-bold text-center md:text-right">${tableTitle}</h2>
                    <div class="flex gap-2 print-hidden">
                         <button onclick="addMatchRow('${tableId}')" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-700 text-sm">
                            <i class="fas fa-plus"></i> إضافة مباراة
                        </button>
                        <button onclick="deleteTable('${tableId}-container')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-700 text-sm ${tableId === 'matches-table' ? 'hidden' : ''}">
                            <i class="fas fa-trash"></i> حذف الجدول
                        </button>
                    </div>
                </div>

                <div id="${tableId}-cards" class="p-4 md:hidden responsive-cards">
                     <p class="text-center text-gray-500 empty-card-message ${!isEmpty ? 'hidden' : ''}">لا توجد مباريات لعرضها.</p>
                </div>

                <div class="overflow-x-auto hidden md:block">
                    <table id="${tableId}" class="min-w-full responsive-table">
                         <thead class="bg-gray-800 text-white">
                             <tr>
                                 <th class="px-2 py-1 border border-gray-300">الفريق الأول</th>
                                 <th class="px-2 py-1 border border-gray-300">N1</th>
                                 <th class="px-2 py-1 border border-gray-300">الفريق الثاني</th>
                                 <th class="px-2 py-1 border border-gray-300">N2</th>
                                 <th class="px-2 py-1 border border-gray-300">الفائز</th>
                                 <th class="px-2 py-1 border border-gray-300">الخاسر</th>
                                 <th class="px-2 py-1 border border-gray-300">P1</th>
                                 <th class="px-2 py-1 border border-gray-300">P2</th>
                                 <th class="px-2 py-1 border border-gray-300">التاريخ</th>
                                 <th class="px-2 py-1 border border-gray-300">الوقت</th>
                                 <th class="px-2 py-1 border border-gray-300 print-hidden">إجراءات</th>
                             </tr>
                         </thead>
                        <tbody></tbody>
                    </table>
                     <p class="text-center text-gray-500 p-4 empty-table-message ${!isEmpty ? 'hidden md:hidden' : 'md:block'}">لا توجد مباريات لعرضها.</p>
                </div>
            `;
            tablesContainer.appendChild(tableWrapper);
        }

        function addNewTable() {
            let savedTables = JSON.parse(localStorage.getItem('savedTables')) || [];
            const newTableId = `custom-table-${generateUniqueId()}`;
            
            showPromptDialog("أدخل عنوان الجدول الجديد:", `دوري جديد`, (tableTitle) => {
                if (!tableTitle || tableTitle.trim() === "") {
                    tableTitle = `دوري ${savedTables.length + 1}`;
                }

                if (savedTables.includes(newTableId) || localStorage.getItem(newTableId)) {
                    addNewTable();
                    return;
                }

                createTableStructure(newTableId, tableTitle);
                loadMatches(newTableId); 

                savedTables.push(newTableId);
                localStorage.setItem('savedTables', JSON.stringify(savedTables));
                localStorage.setItem(`${newTableId}-title`, tableTitle);
                localStorage.setItem(newTableId, JSON.stringify([]));
            });
        }

        function deleteTable(containerId) {
             const tableWrapper = document.getElementById(containerId);
             if (!tableWrapper) return;
             const tableId = tableWrapper.dataset.tableId;

             if (tableId === 'matches-table') {
                 showAlert('لا يمكن حذف الجدول الأساسي.');
                 return;
             }

             showConfirmDialog(`هل أنت متأكد من حذف جدول "${localStorage.getItem(tableId + '-title') || tableId}" بالكامل؟ هذه العملية لا يمكن التراجع عنها.`, () => {
                tableWrapper.remove();
                localStorage.removeItem(tableId);
                localStorage.removeItem(`${tableId}-title`);
                let savedTables = JSON.parse(localStorage.getItem('savedTables')) || [];
                savedTables = savedTables.filter(id => id !== tableId);
                localStorage.setItem('savedTables', JSON.stringify(savedTables));

                 if (document.getElementById('tables-container').children.length === 0) {
                     if (!document.getElementById('matches-table-container')) {
                         createTableStructure('matches-table', 'جدول المباريات الأساسي');
                         loadMatches('matches-table');
                     }
                 }
            });
        }

        function loadMatches(tableId) {
             const matches = JSON.parse(localStorage.getItem(tableId)) || [];
             const tableContainer = document.getElementById(`${tableId}-container`);
             if (!tableContainer) return;

             const tbody = tableContainer.querySelector(`#${tableId} tbody`);
             const cardsContainer = tableContainer.querySelector(`#${tableId}-cards`);
             const emptyTableMsg = tableContainer.querySelector('.empty-table-message');
             const emptyCardMsg = cardsContainer.querySelector('.empty-card-message');

             if (tbody) tbody.innerHTML = '';
             if (cardsContainer) {
                  cardsContainer.querySelectorAll('.match-card').forEach(card => card.remove());
             }

            if (matches.length > 0) {
                matches.forEach(match => {
                    appendMatchElements(tableId, match);
                });
                 if(emptyTableMsg) emptyTableMsg.classList.add('hidden', 'md:hidden');
                 if(emptyCardMsg) emptyCardMsg.classList.add('hidden');
            } else {
                 if(emptyTableMsg) emptyTableMsg.classList.remove('hidden', 'md:hidden');
                 if(emptyCardMsg) emptyCardMsg.classList.remove('hidden');
            }
        }

        function addMatchRow(tableId) {
            const matchId = generateUniqueId();
            const newMatchData = { id: matchId };

            appendMatchElements(tableId, newMatchData);
            saveMatches(tableId);

             const tableContainer = document.getElementById(`${tableId}-container`);
             if (!tableContainer) return;
             const emptyTableMsg = tableContainer.querySelector('.empty-table-message');
             const emptyCardMsg = tableContainer.querySelector(`#${tableId}-cards .empty-card-message`);
             if(emptyTableMsg) emptyTableMsg.classList.add('hidden', 'md:hidden');
             if(emptyCardMsg) emptyCardMsg.classList.add('hidden');
        }

        function appendMatchElements(tableId, match) {
            const tableContainer = document.getElementById(`${tableId}-container`);
            if (!tableContainer) return;

            const tbody = tableContainer.querySelector(`#${tableId} tbody`);
            const cardsContainer = tableContainer.querySelector(`#${tableId}-cards`);
            if (!tbody || !cardsContainer) return;

            const matchId = match.id || generateUniqueId();

            const row = document.createElement('tr');
            row.dataset.matchId = matchId;
            row.innerHTML = `
                <td class="border border-gray-300"><input type="text" class="team1 w-full text-center rounded p-1" value="${match.team1 || ''}" oninput="updateMatchData('${tableId}', '${matchId}')"></td>
                <td class="border border-gray-300"><input type="number" class="team1-score w-16 text-center rounded p-1" value="${match.team1Score || ''}" oninput="updateMatchData('${tableId}', '${matchId}')"></td>
                <td class="border border-gray-300"><input type="text" class="team2 w-full text-center rounded p-1" value="${match.team2 || ''}" oninput="updateMatchData('${tableId}', '${matchId}')"></td>
                <td class="border border-gray-300"><input type="number" class="team2-score w-16 text-center rounded p-1" value="${match.team2Score || ''}" oninput="updateMatchData('${tableId}', '${matchId}')"></td>
                <td class="winner border border-gray-300">${match.winner || '-'}</td>
                <td class="loser border border-gray-300">${match.loser || '-'}</td>
                <td class="team1-points border border-gray-300">${match.team1Points || '-'}</td>
                <td class="team2-points border border-gray-300">${match.team2Points || '-'}</td>
                <td class="border border-gray-300"><input type="date" class="date w-full text-center rounded p-1" value="${match.date || ''}" onchange="updateMatchData('${tableId}', '${matchId}')"></td>
                <td class="border border-gray-300"><input type="time" class="time w-full text-center rounded p-1" value="${match.time || ''}" onchange="updateMatchData('${tableId}', '${matchId}')"></td>
                <td class="border border-gray-300 print-hidden">
                    <button onclick="deleteMatch('${tableId}', '${matchId}')" class="action-btn text-red-500 hover:text-red-700 px-1"><i class="fas fa-trash"></i></button>
                </td>
            `;
             if (tbody.firstChild) {
                 tbody.insertBefore(row, tbody.firstChild);
             } else {
                 tbody.appendChild(row);
             }

            const card = document.createElement('div');
            card.className = 'match-card';
            card.dataset.matchId = matchId;
            card.innerHTML = `
                <div class="match-card-header">
                    <button class="collapse-btn print-hidden" onclick="toggleMatchCard('${matchId}')">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <div class="team-block" data-team-name="${match.team1 || 'الفريق الأول'}" data-team-score="${match.team1Score || '-'}">
                        <input type="text" class="team1 w-full text-center font-bold p-1 border-b rounded mb-1" placeholder="الفريق الأول" value="${match.team1 || ''}" oninput="updateMatchData('${tableId}', '${matchId}')">
                        <input type="number" class="team1-score w-16 text-center text-xl font-bold p-1 border rounded" placeholder="-" value="${match.team1Score || ''}" oninput="updateMatchData('${tableId}', '${matchId}')">
                    </div>
                    <span class="vs">VS</span>
                    <div class="team-block" data-team-name="${match.team2 || 'الفريق الثاني'}" data-team-score="${match.team2Score || '-'}">
                        <input type="text" class="team2 w-full text-center font-bold p-1 border-b rounded mb-1" placeholder="الفريق الثاني" value="${match.team2 || ''}" oninput="updateMatchData('${tableId}', '${matchId}')">
                        <input type="number" class="team2-score w-16 text-center text-xl font-bold p-1 border rounded" placeholder="-" value="${match.team2Score || ''}" oninput="updateMatchData('${tableId}', '${matchId}')">
                    </div>
                </div>

                <div class="match-card-collapsible">
                    <div class="match-card-details">
                        <div><span class="label">الفائز:</span> <span class="value winner-display">${match.winner || '-'}</span></div>
                        <div><span class="label">الخاسر:</span> <span class="value loser-display">${match.loser || '-'}</span></div>
                        <div><span class="label">نقاط ف1:</span> <span class="value team1-points-display">${match.team1Points || '-'}</span></div>
                        <div><span class="label">نقاط ف2:</span> <span class="value team2-points-display">${match.team2Points || '-'}</span></div>
                    </div>

                    <div class="match-card-datetime">
                        <div>
                            <span class="label">التاريخ:</span>
                            <input type="date" class="date border-b p-1" value="${match.date || ''}" onchange="updateMatchData('${tableId}', '${matchId}')">
                        </div>
                        <div>
                            <span class="label">الوقت:</span>
                            <input type="time" class="time border-b p-1" value="${match.time || ''}" onchange="updateMatchData('${tableId}', '${matchId}')">
                        </div>
                    </div>

                    <div class="match-card-actions print-hidden">
                        <button onclick="deleteMatch('${tableId}', '${matchId}')" class="action-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
             const emptyCardMsg = cardsContainer.querySelector('.empty-card-message');
             if (emptyCardMsg) {
                 cardsContainer.insertBefore(card, emptyCardMsg.nextSibling);
             } else if (cardsContainer.firstChild) {
                 cardsContainer.insertBefore(card, cardsContainer.firstChild);
             }
             else {
                 cardsContainer.appendChild(card);
             }

            if (match.team1Score !== undefined || match.team2Score !== undefined || match.team1 || match.team2) {
                calculateAndUpdateResults(tableId, matchId);
            }
        }

        function deleteMatch(tableId, matchId) {
             showConfirmDialog('هل أنت متأكد من حذف هذه المباراة؟', () => {
                const tableContainer = document.getElementById(`${tableId}-container`);
                 if (!tableContainer) return;

                 const row = tableContainer.querySelector(`#${tableId} tr[data-match-id="${matchId}"]`);
                 if (row) row.remove();
                 const card = tableContainer.querySelector(`#${tableId}-cards div[data-match-id="${matchId}"]`);
                 if (card) card.remove();

                 saveMatches(tableId);

                 const tbody = tableContainer.querySelector(`#${tableId} tbody`);
                 const cardsContainer = tableContainer.querySelector(`#${tableId}-cards`);
                 const emptyTableMsg = tableContainer.querySelector('.empty-table-message');
                 const emptyCardMsg = cardsContainer.querySelector('.empty-card-message');

                 if (tbody && tbody.children.length === 0) {
                      if(emptyTableMsg) emptyTableMsg.classList.remove('hidden', 'md:hidden');
                 }
                 if (cardsContainer && cardsContainer.querySelectorAll('.match-card').length === 0) {
                      if(emptyCardMsg) emptyCardMsg.classList.remove('hidden');
                 }
            });
        }

        function updateMatchData(tableId, matchId) {
            calculateAndUpdateResults(tableId, matchId);
            saveMatches(tableId);
        }

        function calculateAndUpdateResults(tableId, matchId) {
            const tableContainer = document.getElementById(`${tableId}-container`);
            if (!tableContainer) return;

            const row = tableContainer.querySelector(`#${tableId} tr[data-match-id="${matchId}"]`);
            const card = tableContainer.querySelector(`#${tableId}-cards div[data-match-id="${matchId}"]`);
            if (!row || !card) return;
            
            const cardTeam1Input = card.querySelector('.team1');
            const cardTeam2Input = card.querySelector('.team2');
            const cardTeam1ScoreInput = card.querySelector('.team1-score');
            const cardTeam2ScoreInput = card.querySelector('.team2-score');
            const cardDateInput = card.querySelector('.date');
            const cardTimeInput = card.querySelector('.time');

            const team1Name = cardTeam1Input.value.trim();
            const team1ScoreValue = cardTeam1ScoreInput.value;
            const team2Name = cardTeam2Input.value.trim();
            const team2ScoreValue = cardTeam2ScoreInput.value;
            const dateValue = cardDateInput.value || '';
            const timeValue = cardTimeInput.value || '';

            row.querySelector('.team1').value = team1Name;
            row.querySelector('.team1-score').value = team1ScoreValue;
            row.querySelector('.team2').value = team2Name;
            row.querySelector('.team2-score').value = team2ScoreValue;
            row.querySelector('.date').value = dateValue;
            row.querySelector('.time').value = timeValue;

            const team1Score = team1ScoreValue === '' ? null : parseInt(team1ScoreValue);
            const team2Score = team2ScoreValue === '' ? null : parseInt(team2ScoreValue);

            let winner = '-';
            let loser = '-';
            let team1Points = '-';
            let team2Points = '-';

            if (team1Name && team2Name && team1Score !== null && team2Score !== null && !isNaN(team1Score) && !isNaN(team2Score)) {
                if (team1Score > team2Score) {
                    winner = team1Name;
                    loser = team2Name;
                    team1Points = 3;
                    team2Points = 0;
                } else if (team1Score < team2Score) {
                    winner = team2Name;
                    loser = team1Name;
                    team1Points = 0;
                    team2Points = 3;
                } else {
                    winner = 'تعادل';
                    loser = 'تعادل';
                    team1Points = 1;
                    team2Points = 1;
                }
            }
            
            row.querySelector('.winner').textContent = winner;
            row.querySelector('.loser').textContent = loser;
            row.querySelector('.team1-points').textContent = team1Points;
            row.querySelector('.team2-points').textContent = team2Points;

            card.querySelector('.winner-display').textContent = winner;
            card.querySelector('.loser-display').textContent = loser;
            card.querySelector('.team1-points-display').textContent = team1Points;
            card.querySelector('.team2-points-display').textContent = team2Points;
            
            card.querySelector('.team-block:nth-child(2)').setAttribute('data-team-name', team1Name || 'الفريق الأول');
            card.querySelector('.team-block:nth-child(2)').setAttribute('data-team-score', team1ScoreValue || '-');
            card.querySelector('.team-block:nth-child(4)').setAttribute('data-team-name', team2Name || 'الفريق الثاني');
            card.querySelector('.team-block:nth-child(4)').setAttribute('data-team-score', team2ScoreValue || '-');
        }

        function saveMatches(tableId) {
             const matches = [];
             const tableContainer = document.getElementById(`${tableId}-container`);
             if (!tableContainer) return;
             const rows = tableContainer.querySelectorAll(`#${tableId} tbody tr`);

             for (let i = rows.length - 1; i >= 0; i--) {
                 const row = rows[i];
                 const matchId = row.dataset.matchId;
                 if (!matchId) continue;

                 matches.push({
                     id: matchId,
                     team1: row.querySelector('.team1').value,
                     team1Score: row.querySelector('.team1-score').value,
                     team2: row.querySelector('.team2').value,
                     team2Score: row.querySelector('.team2-score').value,
                     winner: row.querySelector('.winner').textContent,
                     loser: row.querySelector('.loser').textContent,
                     team1Points: row.querySelector('.team1-points').textContent,
                     team2Points: row.querySelector('.team2-points').textContent,
                     date: row.querySelector('.date').value,
                     time: row.querySelector('.time').value
                 });
             }

             try {
                 localStorage.setItem(tableId, JSON.stringify(matches));

                 let savedTables = JSON.parse(localStorage.getItem('savedTables')) || [];
                 if (!savedTables.includes(tableId)) {
                     savedTables.push(tableId);
                     localStorage.setItem('savedTables', JSON.stringify(savedTables));
                 }
                  if (tableId === 'matches-table' && !localStorage.getItem('matches-table-title')) {
                     localStorage.setItem('matches-table-title', 'جدول المباريات الأساسي');
                 }

             } catch (e) {
                 console.error("Error saving to localStorage:", e);
                 showAlert("حدث خطأ أثناء حفظ البيانات. قد يكون التخزين المحلي ممتلئًا.");
             }
        }
        
        function showStatistics() {
            const modal = document.getElementById('statsModal');
            modal.classList.remove('hidden');
            calculateStatistics();
        }

        function closeStatistics() {
            const modal = document.getElementById('statsModal');
            modal.classList.add('hidden');
        }

        function calculateStatistics() {
            const allMatches = [];
            let savedTables = JSON.parse(localStorage.getItem('savedTables')) || [];
            
            if (localStorage.getItem('matches-table') && !savedTables.includes('matches-table')) {
                savedTables.unshift('matches-table');
            }

            savedTables.forEach(tableId => {
                if (localStorage.getItem(tableId)) {
                    const tableMatches = JSON.parse(localStorage.getItem(tableId)) || [];
                    allMatches.push(...tableMatches);
                }
            });

            const validMatches = allMatches.filter(match => 
                match.team1 && match.team2 && 
                match.team1Score !== '' && match.team2Score !== '' &&
                !isNaN(parseInt(match.team1Score)) && !isNaN(parseInt(match.team2Score))
            );

            const totalMatches = validMatches.length;
            const totalGoals = validMatches.reduce((sum, match) => 
                sum + parseInt(match.team1Score) + parseInt(match.team2Score), 0);
            
            const teams = new Set();
            validMatches.forEach(match => {
                teams.add(match.team1);
                teams.add(match.team2);
            });
            const totalTeams = teams.size;
            const avgGoalsPerMatch = totalMatches > 0 ? (totalGoals / totalMatches).toFixed(2) : 0;

            document.getElementById('totalMatches').textContent = totalMatches;
            document.getElementById('totalGoals').textContent = totalGoals;
            document.getElementById('totalTeams').textContent = totalTeams;
            document.getElementById('avgGoalsPerMatch').textContent = avgGoalsPerMatch;

            const teamStats = {};
            
            validMatches.forEach(match => {
                const team1 = match.team1;
                const team2 = match.team2;
                const team1Score = parseInt(match.team1Score);
                const team2Score = parseInt(match.team2Score);

                if (!teamStats[team1]) {
                    teamStats[team1] = { matches: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, points: 0 };
                }
                if (!teamStats[team2]) {
                    teamStats[team2] = { matches: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, points: 0 };
                }

                teamStats[team1].matches++;
                teamStats[team2].matches++;
                teamStats[team1].goalsFor += team1Score;
                teamStats[team1].goalsAgainst += team2Score;
                teamStats[team2].goalsFor += team2Score;
                teamStats[team2].goalsAgainst += team1Score;

                if (team1Score > team2Score) {
                    teamStats[team1].wins++;
                    teamStats[team1].points += 3;
                    teamStats[team2].losses++;
                } else if (team1Score < team2Score) {
                    teamStats[team2].wins++;
                    teamStats[team2].points += 3;
                    teamStats[team1].losses++;
                } else {
                    teamStats[team1].draws++;
                    teamStats[team2].draws++;
                    teamStats[team1].points += 1;
                    teamStats[team2].points += 1;
                }
            });

            const sortedTeams = Object.entries(teamStats).sort((a, b) => {
                const pointsDiff = b[1].points - a[1].points;
                if (pointsDiff !== 0) return pointsDiff;
                const goalDiffA = a[1].goalsFor - a[1].goalsAgainst;
                const goalDiffB = b[1].goalsFor - b[1].goalsAgainst;
                if(goalDiffA !== goalDiffB) return goalDiffB - goalDiffA;
                return b[1].goalsFor - a[1].goalsFor;
            });

            const teamStatsBody = document.getElementById('teamStatsBody');
            teamStatsBody.innerHTML = '';
            
            sortedTeams.forEach(([teamName, stats]) => {
                const goalDiff = stats.goalsFor - stats.goalsAgainst;
                const winPercentage = stats.matches > 0 ? ((stats.wins / stats.matches) * 100).toFixed(1) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-semibold">${teamName}</td>
                    <td>${stats.matches}</td>
                    <td class="text-green-600 font-bold">${stats.wins}</td>
                    <td class="text-yellow-600 font-bold">${stats.draws}</td>
                    <td class="text-red-600 font-bold">${stats.losses}</td>
                    <td class="text-blue-600">${stats.goalsFor}</td>
                    <td class="text-red-500">${stats.goalsAgainst}</td>
                    <td class="${goalDiff >= 0 ? 'text-green-600' : 'text-red-600'} font-bold">${goalDiff > 0 ? '+' : ''}${goalDiff}</td>
                    <td class="text-purple-600 font-bold">${stats.points}</td>
                    <td>${winPercentage}%</td>
                `;
                teamStatsBody.appendChild(row);
            });

            const topScorers = sortedTeams
                .filter(([_, stats]) => stats.matches > 0)
                .sort((a, b) => b[1].goalsFor - a[1].goalsFor)
                .slice(0, 5);
            
            const topScorersContainer = document.getElementById('topScorers');
            topScorersContainer.innerHTML = '';
            topScorers.forEach(([teamName, stats], index) => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 bg-green-50 rounded border-l-4 border-green-500';
                item.innerHTML = `
                    <span class="font-semibold">${index + 1}. ${teamName}</span>
                    <span class="text-green-600 font-bold">${stats.goalsFor} أهداف</span>
                `;
                topScorersContainer.appendChild(item);
            });

            const bestDefenders = sortedTeams
                .filter(([_, stats]) => stats.matches > 0)
                .sort((a, b) => a[1].goalsAgainst - b[1].goalsAgainst)
                .slice(0, 5);
            
            const bestDefendersContainer = document.getElementById('bestDefenders');
            bestDefendersContainer.innerHTML = '';
            bestDefenders.forEach(([teamName, stats], index) => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 bg-blue-50 rounded border-l-4 border-blue-500';
                item.innerHTML = `
                    <span class="font-semibold">${index + 1}. ${teamName}</span>
                    <span class="text-blue-600 font-bold">${stats.goalsAgainst} أهداف مستقبلة</span>
                `;
                bestDefendersContainer.appendChild(item);
            });
        }
        
        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4';
            modalContent.innerHTML = `
                <div class="flex items-center justify-center mb-4">
                    <i class="fas fa-info-circle text-blue-500 text-2xl"></i>
                </div>
                <p class="text-gray-700 dark:text-gray-300 mb-4 text-center">${message}</p>
                <div class="flex justify-center">
                    <button class="ok-btn px-4 py-2 bg-blue-500 text-white hover:bg-blue-600 rounded">موافق</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            modalContent.querySelector('.ok-btn').addEventListener('click', () => {
                modal.remove();
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4';
            modalContent.innerHTML = `
                <div class="flex items-center justify-center mb-4">
                    <i class="fas fa-question-circle text-yellow-500 text-2xl"></i>
                </div>
                <p class="text-gray-700 dark:text-gray-300 mb-4 text-center">${message}</p>
                <div class="flex justify-center gap-3">
                    <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">إلغاء</button>
                    <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">تأكيد</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            modalContent.querySelector('.cancel-btn').addEventListener('click', () => {
                modal.remove();
            });
            
            modalContent.querySelector('.confirm-btn').addEventListener('click', () => {
                modal.remove();
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function showPromptDialog(message, defaultValue, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4';
            modalContent.innerHTML = `
                <div class="flex items-center justify-center mb-4">
                    <i class="fas fa-edit text-blue-500 text-2xl"></i>
                </div>
                <p class="text-gray-700 dark:text-gray-300 mb-4 text-center">${message}</p>
                <input type="text" class="prompt-input w-full p-3 border border-gray-300 dark:border-gray-600 rounded mb-4 text-center bg-white dark:bg-gray-700 dark:text-gray-200" value="${defaultValue || ''}" placeholder="أدخل النص هنا...">
                <div class="flex justify-center gap-3">
                    <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">إلغاء</button>
                    <button class="confirm-btn px-4 py-2 bg-blue-500 text-white hover:bg-blue-600 rounded">موافق</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            const inputField = modalContent.querySelector('.prompt-input');
            
            setTimeout(() => {
                inputField.focus();
                inputField.select();
            }, 100);
            
            modalContent.querySelector('.cancel-btn').addEventListener('click', () => {
                modal.remove();
            });
            
            modalContent.querySelector('.confirm-btn').addEventListener('click', () => {
                const value = inputField.value.trim();
                modal.remove();
                if (typeof onConfirm === 'function') {
                    onConfirm(value);
                }
            });
            
            inputField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const value = inputField.value.trim();
                    modal.remove();
                    if (typeof onConfirm === 'function') {
                        onConfirm(value);
                    }
                }
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('stats-modal')) {
                closeStatistics();
            }
        });
        
        function toggleMatchCard(matchId) {
            const card = document.querySelector(`[data-match-id="${matchId}"].match-card`);
            if (!card) return;
            
            card.classList.toggle('collapsed');
            
            const cardStates = JSON.parse(localStorage.getItem('cardStates')) || {};
            cardStates[matchId] = card.classList.contains('collapsed');
            localStorage.setItem('cardStates', JSON.stringify(cardStates));
        }

        function loadCardStates() {
            try {
                const cardStates = JSON.parse(localStorage.getItem('cardStates')) || {};
                Object.keys(cardStates).forEach(matchId => {
                    const card = document.querySelector(`[data-match-id="${matchId}"].match-card`);
                    if (card && cardStates[matchId]) {
                        card.classList.add('collapsed');
                    }
                });
            } catch (error) {
                console.error('Error loading card states:', error);
                localStorage.removeItem('cardStates');
            }
        }
        
        function toggleDataMenu() {
            const menu = document.getElementById('dataMenu');
            menu.classList.toggle('hidden');
        }

        document.addEventListener('click', (e) => {
            const menu = document.getElementById('dataMenu');
            const btn = document.getElementById('dataMenuBtn');
            if (menu && !menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        function exportData() {
            try {
                const exportData = {
                    version: "1.0",
                    exportDate: new Date().toISOString(),
                    appName: "جدول المباريات",
                    data: {}
                };

                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (
                        key === 'savedTables' || 
                        key === 'cardStates' || 
                        key === 'matches-table' ||
                        key.endsWith('-title') ||
                        key.startsWith('custom-table-')
                    )) {
                        exportData.data[key] = localStorage.getItem(key);
                    }
                }

                const jsonString = JSON.stringify(exportData, null, 2);
                
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `matches-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                toggleDataMenu();
                showAlert('تم تصدير البيانات بنجاح! تحقق من مجلد التحميلات.');

            } catch (error) {
                console.error('Error exporting data:', error);
                showAlert('حدث خطأ أثناء تصدير البيانات. حاول مرة أخرى.');
            }
        }

        function importData() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.data || typeof importedData.data !== 'object') {
                            showAlert('ملف البيانات غير صحيح. تأكد من أنك تستورد ملف صحيح.');
                            return;
                        }

                        showConfirmDialog(
                            'هل أنت متأكد من استيراد البيانات؟ سيتم استبدال جميع البيانات الحالية بالبيانات المستوردة. هذه العملية لا يمكن التراجع عنها.',
                            () => {
                                try {
                                    clearAllAppData();
                                    
                                    Object.keys(importedData.data).forEach(key => {
                                        localStorage.setItem(key, importedData.data[key]);
                                    });

                                    showAlert('تم استيراد البيانات بنجاح! سيتم إعادة تحميل الصفحة.');
                                    setTimeout(() => {
                                        location.reload();
                                    }, 2000);

                                } catch (error) {
                                    console.error('Error importing data:', error);
                                    showAlert('حدث خطأ أثناء استيراد البيانات. تأكد من صحة الملف.');
                                }
                            }
                        );

                    } catch (error) {
                        console.error('Error parsing imported file:', error);
                        showAlert('لا يمكن قراءة الملف. تأكد من أنه ملف JSON صحيح.');
                    }
                };
                
                reader.readAsText(file);
                document.body.removeChild(fileInput);
            });

            document.body.appendChild(fileInput);
            fileInput.click();
            toggleDataMenu();
        }

        function resetApp() {
            showConfirmDialog(
                'هل أنت متأكد من تهيئة التطبيق؟ سيتم حذف جميع البيانات والعودة إلى الحالة الافتراضية. هذه العملية لا يمكن التراجع عنها.',
                () => {
                    try {
                        clearAllAppData();
                        
                        showAlert('تم تهيئة التطبيق بنجاح! سيتم إعادة تحميل الصفحة.');
                        setTimeout(() => {
                            location.reload();
                        }, 2000);

                    } catch (error) {
                        console.error('Error resetting app:', error);
                        showAlert('حدث خطأ أثناء تهيئة التطبيق. حاول مرة أخرى.');
                    }
                }
            );
            toggleDataMenu();
        }

        function clearAllAppData() {
            const keysToRemove = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (
                    key === 'savedTables' || 
                    key === 'cardStates' || 
                    key === 'matches-table' ||
                    key.endsWith('-title') ||
                    key.startsWith('custom-table-')
                )) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
            });
        }
        
        function printPage() {
            if (window.Android && typeof window.Android.triggerWebViewPrint === 'function') {
                console.log("Calling Android native print function...");
                window.Android.triggerWebViewPrint();
            } else {
                console.warn("Android interface not found. Using standard window.print().");
                window.print();
            }
        }
    </script>
</body>
</html>